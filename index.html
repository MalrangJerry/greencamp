<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=370, height=290, initial-scale=1" />
  <title>LOL Overlay</title>

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
    :root{
      --bg: rgba(18,18,20,.92);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.70);
      --accent:#ffd54f;

      --blue: #4aa8ff;
      --red: #ff4a7a;
      --green: #2ecc71;

      --win: #2ecc71;
      --loss:#e74c3c;
    }

    body{ margin:0; width:370px; height:290px; background:transparent; overflow:hidden; }

    .card{
      position:relative;
      width:370px; height:290px;
      box-sizing:border-box;
      padding:10px;
      background:var(--bg);
      border:1px solid var(--stroke);
      border-radius:0;
      color:var(--text);
      font-family:"Pretendard", system-ui, -apple-system, Segoe UI, sans-serif;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .timer{
      margin-top:0px;
      text-align:center;
      font-weight:900;
      font-size:17px;
      letter-spacing:.6px;
      color:var(--accent);
    }

    .views{
      position:relative;
      margin-top:8px;
      height:250px;
    }

    .view{
      position:absolute; inset:0;
      opacity:0;
      transform: translateY(4px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      visibility:hidden;
    }
    .view.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
      visibility:visible;
    }

    /* SCORE 2 teams */
    .score2Wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .score2Grid{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns: 1fr 5px 1fr;
      align-items:center;
      gap:16px;
      padding:6px 4px;
      box-sizing:border-box;
    }

    .teamTile{
      height:210px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:12px 10px;
      box-sizing:border-box;
      overflow:hidden;
    }

    .teamName{
      font-weight:1000;
      font-size:22px;
      letter-spacing:.2px;
      opacity:.96;
      max-width:160px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }

    .teamScore{
      margin-top:10px;
      font-weight:1000;
      font-size:72px;
      line-height:1;
      font-variant-numeric: tabular-nums;
    }

    .wlLine{
      margin-top:12px;
      padding-top:10px;
      width:100%;
      text-align:center;
      border-top:1px solid rgba(255,255,255,.10);
      font-weight:900;
      font-size:16px;
      letter-spacing:.6px;
      opacity:.85;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    .vsWrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .vsBadge{
      width:auto;
      height:auto;
      border:none;
      border-radius:0;
      background:transparent;
      font-weight:1000;
      font-size:14px;
      opacity:.8;
      text-decoration:none;
    }

    /* SCORE 3+ teams */
    .scoreNWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px 2px;
      box-sizing:border-box;
    }
    .teamRow{
      flex:1;
      min-height:0;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1.25fr .75fr 1.0fr;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      box-sizing:border-box;
      overflow:hidden;
    }
    .rowName{
      font-weight:1000;
      font-size:20.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.96;
    }
    .rowScore{
      text-align:center;
      font-weight:1000;
      font-size:36px;
      line-height:1;
      font-variant-numeric: tabular-nums;
    }
    .rowWL{
      text-align:right;
      font-weight:900;
      font-size:15px;
      letter-spacing:.6px;
      opacity:.86;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    /* PLAYERS VIEW (2 teams only) */
    .listWrap{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding:0 2px;
      box-sizing:border-box;
    }
    .listCol{
      height:100%;
      border:none;
      background:transparent;
      padding:10px 10px;
      box-sizing:border-box;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .listHeader{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-weight:1000;
      font-size:20px;
      letter-spacing:.2px;
      margin-bottom:8px;
      color:var(--muted);
    }

    .players{
      font-size:14px;
      font-weight:600;
      line-height:1.2;
      flex:1;
      min-height:0;
      overflow:hidden;
    }

    .player{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top:0;
      padding:7px 0;
      opacity:.98;
      border-bottom:1px solid rgba(255,255,255,.10);
      gap:10px;
    }
    .players .player:first-child{
      border-top:1px solid rgba(255,255,255,.10);
    }

    .pname{
      max-width:140px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pscore{
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
      white-space:nowrap;
      opacity:.95;
      flex:0 0 auto;
    }

    .dense .players{ font-size:14px; }
    .dense .player{ padding:6px 0; }

    .muted{ color:var(--muted); }

    /* ‚úÖ 3ÌåÄ+ PLAYERS VIEW (Í∞ÄÎ°úÏ§Ñ row + ÌÜ†ÌÉà Ï†êÏàò ÏûëÍ≤å + ÏÑ†Ïàò ÏäπÌå® ÌëúÏãú) */
    .playersNWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:6px 2px;
      box-sizing:border-box;
      overflow:hidden;
    }
    .playersNTop{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-weight:1000;
      font-size:13px;
      letter-spacing:.2px;
      opacity:.75;
      padding:0 4px;
      box-sizing:border-box;
    }

    .playersNRows{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .teamRowN{
      flex:1;
      min-height:0;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1.25fr 2.75fr; /* ÌåÄ(meta) | ÏÑ†Ïàò */
      gap:10px;
      align-items:center;
      padding:10px 10px;
      box-sizing:border-box;
      overflow:hidden;
    }

    .teamMeta{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .teamRowNName{
      font-weight:1000;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.96;
    }

    .teamScoreMini{
      display:inline-flex;
      align-items:baseline;
      gap:6px;
      font-weight:1000;
      font-size:13px;
      opacity:.9;
      white-space:nowrap;
    }
    .teamScoreMini .num{
      font-variant-numeric: tabular-nums;
      font-size:18px;
      line-height:1;
    }

    .teamRowNPlayers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      column-gap:10px;
      row-gap:6px;
      overflow:hidden;
    }

    .pitem{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
      min-width:0;
    }
    .pnick{
      min-width:0;
      flex:1;                     /* üî• Í≥µÍ∞Ñ ÏµúÎåÄ ÌôïÎ≥¥ */
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:600;            /* 500 ‚Üí 600 (ÎÑàÎ¨¥ ÏñáÏßÄ ÏïäÍ≤å) */
      font-size:12.8px;           /* 12.5 ‚Üí 12.8 (Í∞ÄÎèÖÏÑ± Ìñ•ÏÉÅ) */
      color:#ffffff;
    }
    .pwl{
      flex:0 0 auto;              /* üî• Í≥†Ï†ïÌè≠ ÌôïÎ≥¥ */
      white-space:nowrap;
      font-weight:700;            /* 800 ‚Üí 700 (Îçú Í≥ºÌï®) */
      font-size:10.5px;             /* 12 ‚Üí 11 (Í≥µÍ∞Ñ ÌôïÎ≥¥) */
      letter-spacing:.2px;
      color:rgba(255,255,255,.78);/* ÏïΩÍ∞Ñ Î≥¥Ï°∞ÌÜ§ */
      font-variant-numeric: tabular-nums;
    }

    /* FULLSCREEN MATCH ALERT */
    .alert{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:#000;
      border-radius:0;
      opacity:0;
      pointer-events:none;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
      z-index:50;
    }
    .alert.show{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }

    .alertResult{
      font-weight:1000;
      font-size:58px;
      line-height:1;
      letter-spacing:0.5px;
    }
    .alertResult.win{ color:var(--win); }
    .alertResult.loss{ color:var(--loss); }

    .alertTeam{
      font-weight:1000;
      font-size:34px;
      letter-spacing:.3px;
      max-width:340px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-align:center;
      opacity:.95;
    }

    .alertStreamer{
      font-weight:1000;
      font-size:22px;
      letter-spacing:.2px;
      color:rgba(255,255,255,.92);
      max-width:340px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-align:center;
    }

    .alertKda{
      font-weight:900;
      font-size:18px;
      letter-spacing:.3px;
      color:rgba(255,255,255,.86);
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>

<body>
  <div id="card" class="card">

    <div id="timer" class="timer">ÎÇ®ÏùÄÏãúÍ∞Ñ 00:00:00</div>

    <div class="views">
      <!-- SCORE 2 teams -->
      <div id="viewScore2" class="view active">
        <div class="score2Wrap">
          <div class="score2Grid">
            <div id="tileA" class="teamTile">
              <div id="teamAName" class="teamName">TEAM A</div>
              <div id="teamAScore" class="teamScore">0</div>
              <div id="teamAWL" class="wlLine">W 0 / L 0</div>
            </div>

            <div class="vsWrap">
              <div class="vsBadge">VS</div>
            </div>

            <div id="tileB" class="teamTile">
              <div id="teamBName" class="teamName">TEAM B</div>
              <div id="teamBScore" class="teamScore">0</div>
              <div id="teamBWL" class="wlLine">W 0 / L 0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- SCORE 3+ teams -->
      <div id="viewScoreN" class="view">
        <div id="scoreNWrap" class="scoreNWrap"></div>
      </div>

      <!-- PLAYERS (2 teams only) -->
      <div id="viewPlayers" class="view">
        <div class="listWrap">
          <div class="listCol">
            <div class="listHeader">
              <span id="blueNameB" class="muted">TEAM A</span>
              <span id="blueTotalB" class="muted">0</span>
            </div>
            <div id="bluePlayers" class="players"></div>
          </div>

          <div class="listCol">
            <div class="listHeader">
              <span id="redNameB" class="muted">TEAM B</span>
              <span id="redTotalB" class="muted">0</span>
            </div>
            <div id="redPlayers" class="players"></div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ PLAYERS (3+ teams) -->
      <div id="viewPlayersN" class="view">
        <div class="playersNWrap">
          <div class="playersNTop">
          </div>
          <div id="playersNRows" class="playersNRows"></div>
        </div>
      </div>
    </div>

    <!-- FULLSCREEN ALERT -->
    <div id="alert" class="alert">
      <div id="alertResult" class="alertResult win">ÏäπÎ¶¨</div>
      <div id="alertTeam" class="alertTeam"></div>
      <div id="alertStreamer" class="alertStreamer"></div>
      <div id="alertKda" class="alertKda">KDA 0/0/0</div>
    </div>

  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://nnvfzuwvhzsmrwddzhtm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5udmZ6dXd2aHpzbXJ3ZGR6aHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTE2NTgsImV4cCI6MjA4NjYyNzY1OH0.aZ_78os2YeL6vKKiQFDQnWDLGwZP7YMTsZ82iunm8wY";
    const LOBBY_ID = "lobby1";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PERIOD_MS = 10000;  // ÌôîÎ©¥ ÌÜ†Í∏Ä Ï£ºÍ∏∞
    const PAGE_MS = 5000;     // (3ÌåÄ+) ÏÑ†Ïàò ÌôîÎ©¥ÏóêÏÑú ÌåÄ ÌéòÏù¥ÏßÄ ÎÑòÍπÄ Ï£ºÍ∏∞
    const ALERT_MS = 8000;

    // ---------- sound ----------
    let audioCtx = null;
function playPop(){
try{
if(!audioCtx){
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
}
audioCtx.resume();
function beep(freq,t0){
const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();
osc.type="sine";
osc.frequency.value=freq;
gain.gain.setValueAtTime(0.0,t0);
gain.gain.linearRampToValueAtTime(0.09,t0+0.01);
gain.gain.linearRampToValueAtTime(0.0,t0+0.15);
osc.connect(gain);
gain.connect(audioCtx.destination);
osc.start(t0);
osc.stop(t0+0.16);
}
const now=audioCtx.currentTime;
beep(250,now);
beep(520,now+0.18);
}catch(e){
console.log("sound error",e);
}
}

    // ---------- state caches ----------
    let lastSettings = null;

    let teamsFromSettings = [
      { key:"blue",  name:"BLUE",  color:"var(--blue)" },
      { key:"red",   name:"RED",   color:"var(--red)"  }
    ];

    let cachedStreamer = "";

    // (3ÌåÄ+) players ÌéòÏù¥ÏßÄ Ï∫êÏãú
    let nPlayersPages = [];      // [[team,team,team],[team...],...]
    let nPlayersPageIdx = 0;

    // ---------- helpers ----------
    function hhmmss(sec){
      sec = Math.max(0, Math.floor(sec));
      const h = String(Math.floor(sec/3600)).padStart(2,"0");
      const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      return `${h}:${m}:${s}`;
    }

    function computeCountdownText(){
      const status = lastSettings?.session_status ?? "IDLE";
      if(status !== "RUNNING") return "ÎÇ®ÏùÄÏãúÍ∞Ñ 00:00:00";

      const start = lastSettings?.session_start_ts ? Date.parse(lastSettings.session_start_ts) : null;
      if(!start) return "ÎÇ®ÏùÄÏãúÍ∞Ñ 00:00:00";

      const duration = Number(lastSettings?.duration_seconds ?? 10800);
      const elapsed = (Date.now() - start) / 1000;
      const remain = duration - elapsed;
      return "ÎÇ®ÏùÄÏãúÍ∞Ñ " + hhmmss(remain);
    }

    function renderTimer(){
      document.getElementById("timer").textContent = computeCountdownText();
    }
    setInterval(renderTimer, 1000);

    function normalizeTeamsFromPayload(payload){
      const t = payload?.teams;
      if(Array.isArray(t)) return t;
      if(t && typeof t === "object"){
        const out = [];
        for(const key of Object.keys(t)){
          out.push({ key, ...(t[key]||{}) });
        }
        return out;
      }
      return [];
    }

    function normalizeTeamsFromSettings(settings){
      const t = settings?.teams_json;
      if(Array.isArray(t) && t.length >= 2){
        return t.map(x=>({
          key: String(x?.key ?? "").trim(),
          name: String(x?.name ?? "").trim() || String(x?.key ?? "").toUpperCase(),
          color: String(x?.color ?? "").trim() || null,
        })).filter(x=>x.key);
      }

      return [
        { key:"blue", name: settings?.team_blue_name ?? "BLUE", color:"#4aa8ff" },
        { key:"red",  name: settings?.team_red_name  ?? "RED",  color:"#ff4a7a" },
      ];
    }

    function colorOf(teamKey){
      const hit = teamsFromSettings.find(t=>t.key === teamKey);
      if(hit?.color) return hit.color;
      if(teamKey === "blue") return "var(--blue)";
      if(teamKey === "red") return "var(--red)";
      if(teamKey === "green") return "var(--green)";
      return "rgba(255,255,255,.85)";
    }

    function nameOf(teamKey, payloadName){
      const hit = teamsFromSettings.find(t=>t.key === teamKey);
      if(hit?.name) return hit.name;
      return payloadName || teamKey.toUpperCase();
    }

    function setActiveView(viewId){
      const ids = ["viewScore2","viewScoreN","viewPlayers","viewPlayersN"];
      for(const id of ids){
        document.getElementById(id).classList.remove("active");
      }
      document.getElementById(viewId).classList.add("active");
    }

    // ---------- rotator (2 teams) ----------
    let mode2 = "SCORE";
    let rotator2 = null;

    function applyMode2Teams(){
      if(mode2 === "SCORE"){
        setActiveView("viewScore2");
      }else{
        setActiveView("viewPlayers");
      }
    }

    function startRotator2(){
      if(rotator2) return;
      applyMode2Teams();
      rotator2 = setInterval(()=>{
        mode2 = (mode2 === "SCORE") ? "PLAYERS" : "SCORE";
        applyMode2Teams();
      }, PERIOD_MS);
    }

    function stopRotator2(){
      if(rotator2){
        clearInterval(rotator2);
        rotator2 = null;
      }
    }

    // ---------- rotator (3+ teams) ----------
    let modeN = "SCORE_N";      // SCORE_N / PLAYERS_N
    let rotatorN = null;
    let pageRotatorN = null;

    function applyModeNTeams(){
      if(modeN === "SCORE_N"){
        setActiveView("viewScoreN");
        stopPageRotatorN();
      }else{
        setActiveView("viewPlayersN");
        startPageRotatorN();
        renderPlayersNPage(nPlayersPageIdx);
      }
    }

    function startRotatorN(){
      if(rotatorN) return;
      applyModeNTeams();
      rotatorN = setInterval(()=>{
        modeN = (modeN === "SCORE_N") ? "PLAYERS_N" : "SCORE_N";
        applyModeNTeams();
      }, PERIOD_MS);
    }

    function stopRotatorN(){
      if(rotatorN){
        clearInterval(rotatorN);
        rotatorN = null;
      }
      stopPageRotatorN();
    }

    function startPageRotatorN(){
      if(pageRotatorN) return;
      pageRotatorN = setInterval(()=>{
        if(modeN !== "PLAYERS_N") return;
        if(!nPlayersPages.length) return;
        nPlayersPageIdx = (nPlayersPageIdx + 1) % nPlayersPages.length;
        renderPlayersNPage(nPlayersPageIdx);
      }, PAGE_MS);
    }

    function stopPageRotatorN(){
      if(pageRotatorN){
        clearInterval(pageRotatorN);
        pageRotatorN = null;
      }
    }

    // ---------- render ----------
    function render2Teams(teamsPayload){
      const A = teamsPayload[0] || {};
      const B = teamsPayload[1] || {};

      const aKey = A.key || "blue";
      const bKey = B.key || "red";

      const aName = nameOf(aKey, A.name);
      const bName = nameOf(bKey, B.name);

      const aW = Number(A.total ?? 0);
      const bW = Number(B.total ?? 0);

      const aPlayers = Array.isArray(A.players) ? A.players : [];
      const bPlayers = Array.isArray(B.players) ? B.players : [];

      const aL = aPlayers.reduce((acc,p)=>acc + (Number(p?.l)||0), 0);
      const bL = bPlayers.reduce((acc,p)=>acc + (Number(p?.l)||0), 0);

      const tileA = document.getElementById("tileA");
      const tileB = document.getElementById("tileB");
      tileA.style.color = colorOf(aKey);
      tileB.style.color = colorOf(bKey);

      document.getElementById("teamAName").textContent = aName;
      document.getElementById("teamBName").textContent = bName;
      document.getElementById("teamAScore").textContent = aW;
      document.getElementById("teamBScore").textContent = bW;
      document.getElementById("teamAWL").textContent = `W ${aW} / L ${aL}`;
      document.getElementById("teamBWL").textContent = `W ${bW} / L ${bL}`;

      const leftName = document.getElementById("blueNameB");
      const rightName = document.getElementById("redNameB");
      const leftTotal = document.getElementById("blueTotalB");
      const rightTotal = document.getElementById("redTotalB");

      leftName.textContent = aName;
      rightName.textContent = bName;
      leftTotal.textContent = aW;
      rightTotal.textContent = bW;

      leftName.style.color = colorOf(aKey);
      leftTotal.style.color = colorOf(aKey);
      rightName.style.color = colorOf(bKey);
      rightTotal.style.color = colorOf(bKey);

      const dense = Math.max(aPlayers.length, bPlayers.length) >= 6;
      document.getElementById("card").classList.toggle("dense", dense);

      const blueBox = document.getElementById("bluePlayers");
      const redBox = document.getElementById("redPlayers");
      blueBox.innerHTML = "";
      redBox.innerHTML = "";

      aPlayers.forEach(p=>{
        blueBox.innerHTML += `
          <div class="player">
            <span class="pname">${p?.name ?? ""}</span>
            <span class="pscore">${Number(p?.w||0)}Ïäπ ${Number(p?.l||0)}Ìå®</span>
          </div>
        `;
      });

      bPlayers.forEach(p=>{
        redBox.innerHTML += `
          <div class="player">
            <span class="pname">${p?.name ?? ""}</span>
            <span class="pscore">${Number(p?.w||0)}Ïäπ ${Number(p?.l||0)}Ìå®</span>
          </div>
        `;
      });
    }

    function renderNTeams(teamsPayload){
      const wrap = document.getElementById("scoreNWrap");
      wrap.innerHTML = "";

      teamsPayload.forEach(t=>{
        const key = t?.key ?? "";
        const name = nameOf(key, t?.name);
        const W = Number(t?.total ?? 0);
        const players = Array.isArray(t?.players) ? t.players : [];
        const L = players.reduce((acc,p)=>acc + (Number(p?.l)||0), 0);

        const row = document.createElement("div");
        row.className = "teamRow";

        const c = colorOf(key);

        row.innerHTML = `
          <div class="rowName" style="color:${c}">${name}</div>
          <div class="rowScore" style="color:${c}">${W}</div>
          <div class="rowWL" style="color:${c}">W ${W} / L ${L}</div>
        `;

        wrap.appendChild(row);
      });
    }

    // ‚úÖ 3ÌåÄ+ ÏÑ†Ïàò ÌôîÎ©¥: 3ÌåÄÏî© ÌéòÏù¥ÏßÄÎ°ú
    function buildPlayersNPages(teamsPayload){
      const teams = Array.isArray(teamsPayload) ? teamsPayload : [];
      const pages = [];
      for(let i=0;i<teams.length;i+=3){
        pages.push(teams.slice(i, i+3));
      }
      nPlayersPages = pages.length ? pages : [[]];
      if(nPlayersPageIdx >= nPlayersPages.length) nPlayersPageIdx = 0;
    }

    function renderPlayersNPage(pageIdx){
      const rows = document.getElementById("playersNRows");

      const totalPages = Math.max(1, nPlayersPages.length);
      const idx = Math.max(0, Math.min(pageIdx, totalPages-1));

      rows.innerHTML = "";

      const pageTeams = nPlayersPages[idx] || [];

      pageTeams.forEach(t=>{
        const key = String(t?.key ?? "").trim();
        const name = nameOf(key, t?.name);
        const W = Number(t?.total ?? 0);
        const players = Array.isArray(t?.players) ? t.players : [];
        const c = colorOf(key);

        const row = document.createElement("div");
        row.className = "teamRowN";

        const playersHtml = players.map(p=>{
          const nm = String(p?.name ?? "").trim();
          const pw = Number(p?.w ?? 0);
          const pl = Number(p?.l ?? 0);
          return `
            <div class="pitem">
              <span class="pnick">${nm}</span>
              <span class="pwl">${pw}Ïäπ ${pl}Ìå®</span>
            </div>
          `;
        }).join("");

        row.innerHTML = `
          <div class="teamMeta">
            <div class="teamRowNName" style="color:${c}">${name}</div>
            <div class="teamScoreMini" style="color:${c}">
              <span>WIN</span><span class="num">${W}</span>
            </div>
          </div>
          <div class="teamRowNPlayers">${playersHtml}</div>
        `;

        rows.appendChild(row);
      });

      // 3Ï§Ñ Í≥†Ï†ï ÎäêÎÇå(Îπà Ï§Ñ Ìå®Îî©)
      const targetRows = 3;
      const missing = targetRows - pageTeams.length;
      for(let i=0;i<missing;i++){
        const empty = document.createElement("div");
        empty.className = "teamRowN";
        empty.style.border = "1px solid rgba(255,255,255,.06)";
        empty.style.background = "rgba(255,255,255,.02)";
        empty.innerHTML = `
          <div class="teamMeta">
            <div class="teamRowNName muted"></div>
            <div class="teamScoreMini muted"><span> </span><span class="num"> </span></div>
          </div>
          <div class="teamRowNPlayers"></div>
        `;
        rows.appendChild(empty);
      }

      const maxPlayers = Math.max(0, ...pageTeams.map(t => (Array.isArray(t?.players) ? t.players.length : 0)));
      const dense = maxPlayers >= 6;
      document.getElementById("card").classList.toggle("dense", dense);
    }

    function renderState(payload){
      if(!payload) return;

      cachedStreamer = String(payload.streamerName ?? payload.streamer_name ?? lastSettings?.streamer_name ?? "").trim();

      const teamsPayload = normalizeTeamsFromPayload(payload);
      const teamCount = teamsFromSettings.length;

      if(teamCount >= 3){
        stopRotator2();

        const fill = (teamsPayload.length >= 3)
          ? teamsPayload
          : teamsFromSettings.map(t=>({ ...t, total:0, players:[] }));

        const ordered = teamsFromSettings.map(s=>{
          const hit = fill.find(x=>String(x.key)===String(s.key));
          return hit ? hit : ({ ...s, total:0, players:[] });
        });

        renderNTeams(ordered);

        buildPlayersNPages(ordered);
        if(modeN === "PLAYERS_N"){
          renderPlayersNPage(nPlayersPageIdx);
        }

        startRotatorN();
        applyModeNTeams();

      }else{
        stopRotatorN();

        startRotator2();
        const fill = (teamsPayload.length >= 2)
          ? teamsPayload
          : teamsFromSettings.map(t=>({ ...t, total:0, players:[] }));

        const ordered = teamsFromSettings.map(s=>{
          const hit = fill.find(x=>String(x.key)===String(s.key));
          return hit ? hit : ({ ...s, total:0, players:[] });
        });

        render2Teams(ordered);
      }
    }

    // ---------- alert ----------
    let alertTimer = null;

    function showAlert(ev){
      const alert = document.getElementById("alert");
      const aResult = document.getElementById("alertResult");
      const aTeam = document.getElementById("alertTeam");
      const aStreamer = document.getElementById("alertStreamer");
      const aKda = document.getElementById("alertKda");

      const isWin = ev?.result === "WIN";

      aResult.textContent = isWin ? "WIN" : "LOSE";
      aResult.className = "alertResult " + (isWin ? "win" : "loss");

      const teamKey = String(ev?.teamKey ?? ev?.team_key ?? "").trim();
      const teamName = String(ev?.teamName ?? ev?.team_name ?? "").trim();
      aTeam.textContent = teamName || "";
      aTeam.style.color = teamKey ? colorOf(teamKey) : "rgba(255,255,255,.92)";

      const playerName = String(ev?.playerName ?? ev?.player_name ?? "").trim();
      aStreamer.textContent = playerName || cachedStreamer || "";

      aKda.textContent = ev?.kda ? `KDA ${ev.kda}` : "KDA -/-/-";

      playPop();

      stopRotator2();
      stopRotatorN();

      alert.classList.add("show");

      clearTimeout(alertTimer);
      alertTimer = setTimeout(()=>{
        alert.classList.remove("show");

        if(teamsFromSettings.length >= 3){
          startRotatorN();
          applyModeNTeams();
        }else{
          startRotator2();
          applyMode2Teams();
        }
      }, ALERT_MS);
    }

    // ---------- fetch ----------
    async function fetchSettings(){
      const { data, error } = await supabase
        .from("lobby_settings")
        .select("*")
        .eq("lobby_id", LOBBY_ID)
        .maybeSingle();

      if(error) return;

      lastSettings = data ?? null;
      teamsFromSettings = normalizeTeamsFromSettings(lastSettings);
      renderTimer();
    }

    async function fetchState(){
      const { data, error } = await supabase
        .from("overlay_state")
        .select("payload")
        .eq("lobby_id", LOBBY_ID)
        .maybeSingle();

      if(error) return;
      if(data?.payload) renderState(data.payload);
    }

    // ---------- init ----------
    await fetchSettings();
    await fetchState();

    setInterval(fetchSettings, 5000);
    setInterval(fetchState, 5000);

    // realtime
    supabase.channel("settings")
      .on("postgres_changes", {
        event: "*", schema: "public", table: "lobby_settings",
        filter: `lobby_id=eq.${LOBBY_ID}`
      }, (e)=>{
        lastSettings = e.new ?? null;
        teamsFromSettings = normalizeTeamsFromSettings(lastSettings);
        renderTimer();
        fetchState().catch(()=>{});
      })
      .subscribe();

    supabase.channel("state")
      .on("postgres_changes", {
        event: "*", schema: "public", table: "overlay_state",
        filter: `lobby_id=eq.${LOBBY_ID}`
      }, (e)=>{
        if(e.new?.payload) renderState(e.new.payload);
      })
      .subscribe();

    supabase.channel("events")
      .on("postgres_changes", {
        event: "INSERT", schema: "public", table: "overlay_events",
        filter: `lobby_id=eq.${LOBBY_ID}`
      }, (e)=>{
        if(e.new?.type === "MATCH_END"){
          showAlert(e.new.payload);
        }
      })
      .subscribe();
  </script>
</body>
</html>

