<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=370, height=290, initial-scale=1" />
  <title>LOL Overlay</title>

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">

  <style>
    :root{
      --bg: rgba(18,18,20,.92);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.70);
      --accent:#ffd54f;

      --blue: #4aa8ff;
      --red: #ff4a7a;
      --green: #2ecc71;

      --win: #2ecc71;
      --loss:#e74c3c;
    }

    body{ margin:0; width:370px; height:290px; background:transparent; overflow:hidden; }

    .card{
      position:relative;
      width:370px; height:290px;
      box-sizing:border-box;
      padding:10px;
      background:var(--bg);
      border:1px solid var(--stroke);
      border-radius:0;
      color:var(--text);
      font-family:"Pretendard", system-ui, -apple-system, Segoe UI, sans-serif;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .timer{
      margin-top:0px;
      text-align:center;
      font-weight:900;
      font-size:17px;
      letter-spacing:.6px;
      color:var(--accent);
    }

    .views{
      position:relative;
      margin-top:8px;
      height:250px;
    }

    .view{
      position:absolute; inset:0;
      opacity:0;
      transform: translateY(4px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      visibility:hidden;
    }
    .view.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
      visibility:visible;
    }

    /* SCORE 2 teams */
    .score2Wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .score2Grid{
      width:100%;
      height:100%;
      display:grid;
      grid-template-columns: 1fr 5px 1fr;
      align-items:center;
      gap:16px;
      padding:6px 4px;
      box-sizing:border-box;
    }

    .teamTile{
      height:210px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:12px 10px;
      box-sizing:border-box;
      overflow:hidden;
    }

    .teamName{
      font-weight:1000;
      font-size:22px;
      letter-spacing:.2px;
      opacity:.96;
      max-width:160px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-align:center;
    }

    .teamScore{
      margin-top:10px;
      font-weight:1000;
      font-size:72px;
      line-height:1;
      font-variant-numeric: tabular-nums;
    }

    .wlLine{
      margin-top:12px;
      padding-top:10px;
      width:100%;
      text-align:center;
      border-top:1px solid rgba(255,255,255,.10);
      font-weight:900;
      font-size:16px;
      letter-spacing:.6px;
      opacity:.85;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    .vsWrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .vsBadge{
      width:auto;
      height:auto;
      border:none;
      border-radius:0;
      background:transparent;
      font-weight:1000;
      font-size:14px;
      opacity:.8;
      text-decoration:none;
    }

    /* SCORE 3+ teams */
    .scoreNWrap{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:6px 2px;
      box-sizing:border-box;
    }
    .teamRow{
      flex:1;
      min-height:0;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid;
      grid-template-columns: 1.25fr .75fr 1.0fr;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      box-sizing:border-box;
      overflow:hidden;
    }
    .rowName{
      font-weight:1000;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.96;
    }
    .rowScore{
      text-align:center;
      font-weight:1000;
      font-size:56px;
      line-height:1;
      font-variant-numeric: tabular-nums;
    }
    .rowWL{
      text-align:right;
      font-weight:900;
      font-size:15px;
      letter-spacing:.6px;
      opacity:.86;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    /* PLAYERS VIEW (2 teams only) */
    .listWrap{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding:0 2px;
      box-sizing:border-box;
    }
    .listCol{
      height:100%;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      padding:10px 10px;
      box-sizing:border-box;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .listHeader{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-weight:1000;
      font-size:20px;
      letter-spacing:.2px;
      margin-bottom:8px;
      color:var(--muted);
    }

    .players{
      font-size:14px;
      font-weight:600;
      line-height:1.2;
      flex:1;
      min-height:0;
      overflow:hidden; /* 원하면 auto */
    }

    .player{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top:0;
      padding:7px 0;
      opacity:.98;
      border-bottom:1px solid rgba(255,255,255,.10);
      gap:10px;
    }
    .players .player:first-child{
      border-top:1px solid rgba(255,255,255,.10);
    }

    .pname{
      max-width:140px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pscore{
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
      white-space:nowrap;
      opacity:.95;
      flex:0 0 auto;
    }

    .dense .players{ font-size:14px; }
    .dense .player{ padding:6px 0; }

    .muted{ color:var(--muted); }

    /* FULLSCREEN MATCH ALERT */
    .alert{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:rgba(0,0,0,.62);
      border-radius:0;
      opacity:0;
      pointer-events:none;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
      z-index:50;
    }
    .alert.show{
      opacity:1;
      pointer-events:auto;
      transform: translateY(0);
    }

    .alertResult{
      font-weight:1000;
      font-size:58px;
      line-height:1;
      letter-spacing:0.5px;
    }
    .alertResult.win{ color:var(--win); }
    .alertResult.loss{ color:var(--loss); }

    .alertStreamer{
      font-weight:1000;
      font-size:22px;
      letter-spacing:.2px;
      color:rgba(255,255,255,.92);
      max-width:340px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-align:center;
    }

    .alertKda{
      font-weight:900;
      font-size:18px;
      letter-spacing:.3px;
      color:rgba(255,255,255,.86);
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>

<body>
  <div id="card" class="card">

    <div id="timer" class="timer">남은시간 00:00:00</div>

    <div class="views">
      <!-- SCORE 2 teams -->
      <div id="viewScore2" class="view active">
        <div class="score2Wrap">
          <div class="score2Grid">
            <div id="tileA" class="teamTile">
              <div id="teamAName" class="teamName">TEAM A</div>
              <div id="teamAScore" class="teamScore">0</div>
              <div id="teamAWL" class="wlLine">W 0 / L 0</div>
            </div>

            <div class="vsWrap">
              <div class="vsBadge">VS</div>
            </div>

            <div id="tileB" class="teamTile">
              <div id="teamBName" class="teamName">TEAM B</div>
              <div id="teamBScore" class="teamScore">0</div>
              <div id="teamBWL" class="wlLine">W 0 / L 0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- SCORE 3+ teams -->
      <div id="viewScoreN" class="view">
        <div id="scoreNWrap" class="scoreNWrap"></div>
      </div>

      <!-- PLAYERS (2 teams only) -->
      <div id="viewPlayers" class="view">
        <div class="listWrap">
          <div class="listCol">
            <div class="listHeader">
              <span id="blueNameB" class="muted">TEAM A</span>
              <span id="blueTotalB" class="muted">0</span>
            </div>
            <div id="bluePlayers" class="players"></div>
          </div>

          <div class="listCol">
            <div class="listHeader">
              <span id="redNameB" class="muted">TEAM B</span>
              <span id="redTotalB" class="muted">0</span>
            </div>
            <div id="redPlayers" class="players"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- FULLSCREEN ALERT -->
    <div id="alert" class="alert">
      <div id="alertResult" class="alertResult win">승리</div>
      <div id="alertStreamer" class="alertStreamer"></div>
      <div id="alertKda" class="alertKda">KDA 0/0/0</div>
    </div>

  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://nnvfzuwvhzsmrwddzhtm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5udmZ6dXd2aHpzbXJ3ZGR6aHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTE2NTgsImV4cCI6MjA4NjYyNzY1OH0.aZ_78os2YeL6vKKiQFDQnWDLGwZP7YMTsZ82iunm8wY";
    const LOBBY_ID = "lobby1";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PERIOD_MS = 10000;
    const ALERT_MS = 6000;

    // ---------- sound ----------
    let audioCtx = null;
    function playPop(){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === "suspended"){
          audioCtx.resume().catch(()=>{});
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 520;

        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.035, now + 0.008);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.08);

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.085);
      }catch(e){
        console.log("sound error", e);
      }
    }

    // ---------- state caches ----------
    let lastSettings = null;

    let teamsFromSettings = [
      { key:"blue",  name:"BLUE",  color:"var(--blue)" },
      { key:"red",   name:"RED",   color:"var(--red)"  }
    ];

    let cachedStreamer = "";

    // ---------- helpers ----------
    function hhmmss(sec){
      sec = Math.max(0, Math.floor(sec));
      const h = String(Math.floor(sec/3600)).padStart(2,"0");
      const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      return `${h}:${m}:${s}`;
    }

    function computeCountdownText(){
      const status = lastSettings?.session_status ?? "IDLE";
      if(status !== "RUNNING") return "남은시간 00:00:00";

      const start = lastSettings?.session_start_ts ? Date.parse(lastSettings.session_start_ts) : null;
      if(!start) return "남은시간 00:00:00";

      const duration = Number(lastSettings?.duration_seconds ?? 10800);
      const elapsed = (Date.now() - start) / 1000;
      const remain = duration - elapsed;
      return "남은시간 " + hhmmss(remain);
    }

    function renderTimer(){
      document.getElementById("timer").textContent = computeCountdownText();
    }
    setInterval(renderTimer, 1000);

    function normalizeTeamsFromPayload(payload){
      const t = payload?.teams;
      if(Array.isArray(t)) return t;
      if(t && typeof t === "object"){
        const out = [];
        for(const key of Object.keys(t)){
          out.push({ key, ...(t[key]||{}) });
        }
        return out;
      }
      return [];
    }

    function normalizeTeamsFromSettings(settings){
      const t = settings?.teams_json;
      if(Array.isArray(t) && t.length >= 2){
        return t.map(x=>({
          key: String(x?.key ?? "").trim(),
          name: String(x?.name ?? "").trim() || String(x?.key ?? "").toUpperCase(),
          color: String(x?.color ?? "").trim() || null,
        })).filter(x=>x.key);
      }

      return [
        { key:"blue", name: settings?.team_blue_name ?? "BLUE", color:"#4aa8ff" },
        { key:"red",  name: settings?.team_red_name  ?? "RED",  color:"#ff4a7a" },
      ];
    }

    function colorOf(teamKey){
      const hit = teamsFromSettings.find(t=>t.key === teamKey);
      if(hit?.color) return hit.color;
      if(teamKey === "blue") return "var(--blue)";
      if(teamKey === "red") return "var(--red)";
      if(teamKey === "green") return "var(--green)";
      return "rgba(255,255,255,.85)";
    }

    function nameOf(teamKey, payloadName){
      const hit = teamsFromSettings.find(t=>t.key === teamKey);
      if(hit?.name) return hit.name;
      return payloadName || teamKey.toUpperCase();
    }

    function setActiveView(viewId){
      const ids = ["viewScore2","viewScoreN","viewPlayers"];
      for(const id of ids){
        document.getElementById(id).classList.remove("active");
      }
      document.getElementById(viewId).classList.add("active");
    }

    // ---------- rotator (2팀일 때만) ----------
    let mode = "SCORE";
    let rotator = null;

    function applyMode2Teams(){
      if(mode === "SCORE"){
        setActiveView("viewScore2");
      }else{
        setActiveView("viewPlayers");
      }
    }

    function startRotator(){
      if(rotator) return;
      applyMode2Teams();
      rotator = setInterval(()=>{
        mode = (mode === "SCORE") ? "PLAYERS" : "SCORE";
        applyMode2Teams();
      }, PERIOD_MS);
    }

    function stopRotator(){
      if(rotator){
        clearInterval(rotator);
        rotator = null;
      }
    }

    // ---------- render ----------
    function render2Teams(teamsPayload){
      const A = teamsPayload[0] || {};
      const B = teamsPayload[1] || {};

      const aKey = A.key || "blue";
      const bKey = B.key || "red";

      const aName = nameOf(aKey, A.name);
      const bName = nameOf(bKey, B.name);

      const aW = Number(A.total ?? 0);
      const bW = Number(B.total ?? 0);

      const aPlayers = Array.isArray(A.players) ? A.players : [];
      const bPlayers = Array.isArray(B.players) ? B.players : [];

      const aL = aPlayers.reduce((acc,p)=>acc + (Number(p?.l)||0), 0);
      const bL = bPlayers.reduce((acc,p)=>acc + (Number(p?.l)||0), 0);

      const tileA = document.getElementById("tileA");
      const tileB = document.getElementById("tileB");
      tileA.style.color = colorOf(aKey);
      tileB.style.color = colorOf(bKey);

      document.getElementById("teamAName").textContent = aName;
      document.getElementById("teamBName").textContent = bName;
      document.getElementById("teamAScore").textContent = aW;
      document.getElementById("teamBScore").textContent = bW;
      document.getElementById("teamAWL").textContent = `W ${aW} / L ${aL}`;
      document.getElementById("teamBWL").textContent = `W ${bW} / L ${bL}`;

      const leftName = document.getElementById("blueNameB");
      const rightName = document.getElementById("redNameB");
      const leftTotal = document.getElementById("blueTotalB");
      const rightTotal = document.getElementById("redTotalB");

      leftName.textContent = aName;
      rightName.textContent = bName;
      leftTotal.textContent = aW;
      rightTotal.textContent = bW;

      leftName.style.color = colorOf(aKey);
      leftTotal.style.color = colorOf(aKey);
      rightName.style.color = colorOf(bKey);
      rightTotal.style.color = colorOf(bKey);

      const dense = Math.max(aPlayers.length, bPlayers.length) >= 6;
      document.getElementById("card").classList.toggle("dense", dense);

      const blueBox = document.getElementById("bluePlayers");
      const redBox = document.getElementById("redPlayers");
      blueBox.innerHTML = "";
      redBox.innerHTML = "";

      aPlayers.forEach(p=>{
        blueBox.innerHTML += `
          <div class="player">
            <span class="pname">${p?.name ?? ""}</span>
            <span class="pscore">${Number(p?.w||0)}승 ${Number(p?.l||0)}패</span>
          </div>
        `;
      });

      bPlayers.forEach(p=>{
        redBox.innerHTML += `
          <div class="player">
            <span class="pname">${p?.name ?? ""}</span>
            <span class="pscore">${Number(p?.w||0)}승 ${Number(p?.l||0)}패</span>
          </div>
        `;
      });

      // ✅ (중요) 예전 코드에서 blueSum/redSum을 쓰다가 ReferenceError 나서 전체 스크립트가 죽었음
      // 그래서 토스트/이벤트 구독까지 못 갔던 것.
      // 여기서는 관련 라인을 제거했음.
    }

    function renderNTeams(teamsPayload){
      const wrap = document.getElementById("scoreNWrap");
      wrap.innerHTML = "";

      teamsPayload.forEach(t=>{
        const key = t?.key ?? "";
        const name = nameOf(key, t?.name);
        const W = Number(t?.total ?? 0);
        const players = Array.isArray(t?.players) ? t.players : [];
        const L = players.reduce((acc,p)=>acc + (Number(p?.l)||0), 0);

        const row = document.createElement("div");
        row.className = "teamRow";

        const c = colorOf(key);

        row.innerHTML = `
          <div class="rowName" style="color:${c}">${name}</div>
          <div class="rowScore" style="color:${c}">${W}</div>
          <div class="rowWL" style="color:${c}">W ${W} / L ${L}</div>
        `;

        wrap.appendChild(row);
      });
    }

    function renderState(payload){
      if(!payload) return;

      cachedStreamer = String(payload.streamerName ?? payload.streamer_name ?? lastSettings?.streamer_name ?? "").trim();

      const teamsPayload = normalizeTeamsFromPayload(payload);
      const teamCount = teamsFromSettings.length;

      if(teamCount >= 3){
        stopRotator();
        setActiveView("viewScoreN");
        const fill = (teamsPayload.length >= 3) ? teamsPayload : teamsFromSettings.map(t=>({ ...t, total:0, players:[] }));
        renderNTeams(fill);
      }else{
        startRotator();
        const fill = (teamsPayload.length >= 2) ? teamsPayload : teamsFromSettings.map(t=>({ ...t, total:0, players:[] }));
        const ordered = teamsFromSettings.map(s=>{
          const hit = fill.find(x=>String(x.key)===String(s.key));
          return hit ? hit : ({ ...s, total:0, players:[] });
        });
        render2Teams(ordered);
      }
    }

    // ---------- alert ----------
    let alertTimer = null;

    function showAlert(ev){
      const alert = document.getElementById("alert");
      const aResult = document.getElementById("alertResult");
      const aStreamer = document.getElementById("alertStreamer");
      const aKda = document.getElementById("alertKda");
      const playerName = String(ev?.playerName ?? ev?.player_name ?? "").trim();
      const isWin = ev?.result === "WIN";

      aResult.textContent = isWin ? "승리" : "패배";
      aResult.className = "alertResult " + (isWin ? "win" : "loss");

     aStreamer.textContent = playerName || cachedStreamer || "";
      aKda.textContent = ev?.kda ? `KDA ${ev.kda}` : "KDA -/-/-";

      playPop();

      stopRotator();
      alert.classList.add("show");

      clearTimeout(alertTimer);
      alertTimer = setTimeout(()=>{
        alert.classList.remove("show");
        if(teamsFromSettings.length <= 2){
          startRotator();
        }
      }, ALERT_MS);
    }

    // ---------- fetch ----------
    async function fetchSettings(){
      const { data, error } = await supabase
        .from("lobby_settings")
        .select("*")
        .eq("lobby_id", LOBBY_ID)
        .maybeSingle();

      if(error) return;

      lastSettings = data ?? null;
      teamsFromSettings = normalizeTeamsFromSettings(lastSettings);
      renderTimer();
    }

    async function fetchState(){
      const { data, error } = await supabase
        .from("overlay_state")
        .select("payload")
        .eq("lobby_id", LOBBY_ID)
        .maybeSingle();

      if(error) return;
      if(data?.payload) renderState(data.payload);
    }

    // ---------- init ----------
    await fetchSettings();
    await fetchState();

    setInterval(fetchSettings, 5000);
    setInterval(fetchState, 5000);

    // realtime
    supabase.channel("settings")
      .on("postgres_changes", {
        event: "*", schema: "public", table: "lobby_settings",
        filter: `lobby_id=eq.${LOBBY_ID}`
      }, (e)=>{
        lastSettings = e.new ?? null;
        teamsFromSettings = normalizeTeamsFromSettings(lastSettings);
        renderTimer();
        fetchState().catch(()=>{});
      })
      .subscribe();

    supabase.channel("state")
      .on("postgres_changes", {
        event: "*", schema: "public", table: "overlay_state",
        filter: `lobby_id=eq.${LOBBY_ID}`
      }, (e)=>{
        if(e.new?.payload) renderState(e.new.payload);
      })
      .subscribe();

    supabase.channel("events")
      .on("postgres_changes", {
        event: "INSERT", schema: "public", table: "overlay_events",
        filter: `lobby_id=eq.${LOBBY_ID}`
      }, (e)=>{
        if(e.new?.type === "MATCH_END"){
          showAlert(e.new.payload);
        }
      })
      .subscribe();
  </script>
</body>
</html>
